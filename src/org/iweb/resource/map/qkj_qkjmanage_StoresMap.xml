<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "sql-map-2.dtd">
<sqlMap>
	<!-- Product Start -->
	<typeAlias alias="StoresOrder" type="com.qkj.manage.domain.StoresOrder" />
	<typeAlias alias="product" type="com.qkj.manage.domain.Product" />
	<typeAlias alias="StoresOrderItem" type="com.qkj.manage.domain.StoresOrderItem" />
		<typeAlias alias="StoresTicket" type="com.qkj.manage.domain.StoresTicket" />
	<select id="qkjStores_getProducts" resultClass="product" parameterClass="java.util.Map">
		<![CDATA[ 
			select * from qkj_t_product p
		]]>
		<dynamic prepend="WHERE"> 
				<isNotEmpty prepend="AND" property="code" open="(" close=")"><![CDATA[ p.bar_code=#code# OR p.bar_code_tibet_box=#code# or p.bar_code_tibet=#code# or p.bar_code_box=#code# ]]></isNotEmpty>
			             <isNotEmpty prepend="AND" property="userid"><![CDATA[ p.user_id=#userid# ]]></isNotEmpty>
			             <isNotEmpty prepend="AND" property="title"><![CDATA[ p.title Like '%' + #title# +  '%']]></isNotEmpty>
			             <isNotEmpty prepend="AND" property="puuid"><![CDATA[ p.uuid=#puuid# ]]></isNotEmpty>
			                 
		</dynamic>
	</select>

   	<select id="qkjStores_getProductsSelect" resultClass="product" parameterClass="java.util.Map">
		<![CDATA[ 
			select top 15 * from qkj_t_product p
		]]>
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="code"><![CDATA[ p.bar_code=#code# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="user_id"><![CDATA[ p.user_id=#userid# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="title"><![CDATA[ p.title Like '%' + #title# +  '%']]></isNotEmpty>
		</dynamic>
	</select>

	<insert id="qkjStores_addProducts" parameterClass="java.util.List">  
    <![CDATA[
        insert into qkj_t_order_item(bar_code,order_id,prod_code,product_price,spec,title,order_total_price,order_num,product_id,brand) values  
    ]]>
		<iterate conjunction=",">
        <![CDATA[(#parameters[].bar_code#,#parameters[].order_id#,#parameters[].prod_code#,#parameters[].product_price#,#parameters[].spec#,#parameters[].title#,#parameters[].order_total_price#,#parameters[].order_num#,#parameters[].product_id#,#parameters[].brand#)  
        ]]>
		</iterate>
	</insert>


	<insert id="qkjStores_addOrder" parameterClass="StoresOrder">  
    <![CDATA[
        insert into qkj_t_order(user_id,user_name,total_price,add_time,login_dept,login_name,member_id,member_name,member_mobile,is_liqueur_ticket,liqueur_ticket_code) values 
        (#user_id#,#user_name#,#total_price#,#add_time#,#login_dept#,#login_name#,#member_id#,#member_name#,#member_mobile#,#is_liqueur_ticket#,#liqueur_ticket_code#)  
    ]]>
		<selectKey resultClass="int" type="post" keyProperty="id">
			select @@IDENTITY as value
		</selectKey>
	</insert>
	<select id="qkjStores_Order_update_list" parameterClass="java.util.Map" resultClass="StoresOrder">
		select * from qkj_t_order o
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="time_begin"><![CDATA[ o.add_time>=#time_begin# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="time_end"><![CDATA[ o.add_time<=#time_end# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="is_library"><![CDATA[ o.is_library=#is_library# ]]></isNotEmpty> 
			<isNotEmpty prepend="AND" property="is_liqueur_ticket"><![CDATA[ o.is_liqueur_ticket=#is_liqueur_ticket# ]]></isNotEmpty> 
			<isNotEmpty prepend="AND" property="user_id"><![CDATA[ o.user_id=#userid# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="id"><![CDATA[ o.id=#id# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="apply_depts" open="(" close=")">
			<![CDATA[ o.login_dept In ]]>
			<iterate property="apply_depts" open="(" close=")" conjunction=" , "> #apply_depts[]#</iterate>
			<isNotEmpty prepend="OR" property="apply_perdepts">
				<![CDATA[ o.login_dept In ]]>
				<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
				<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ o.user_id=#apply_userDouble# ]]></isNotEmpty>
			</isNotEmpty>
		</isNotEmpty>
		
		<isEmpty  property="apply_depts">
			<isNotEmpty prepend="AND" property="apply_perdepts">
				<![CDATA[ o.login_dept In ]]>
				<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
				<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ o.user_id=#apply_userDouble# ]]></isNotEmpty>
			</isNotEmpty>
			ORDER BY add_time asc
		</isEmpty>
			
			
			
		</dynamic>
	</select>

	<select id="qkjStores_Order_update_listCount" parameterClass="java.util.Map" resultClass="int">
		select count(*) from qkj_t_order o
		<dynamic prepend="WHERE">
		
			<isNotEmpty prepend="AND" property="time_begin"><![CDATA[ o.add_time>=#time_begin# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="time_end"><![CDATA[ o.add_time<=DATE_ADD(#time_end#,INTERVAL 1 day) ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="is_library"><![CDATA[ o.is_library=#is_library# ]]></isNotEmpty> 
			<isNotEmpty prepend="AND" property="is_liqueur_ticket"><![CDATA[ o.is_liqueur_ticket=#is_liqueur_ticket# ]]></isNotEmpty> 
			<isNotEmpty prepend="AND" property="user_id"><![CDATA[ o.user_id=#userid# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="id"><![CDATA[ o.id=#id# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="apply_depts" open="(" close=")">
			<![CDATA[ o.login_dept In ]]>
			<iterate property="apply_depts" open="(" close=")" conjunction=" , "> #apply_depts[]#</iterate>
			<isNotEmpty prepend="OR" property="apply_perdepts">
				<![CDATA[ o.login_dept In ]]>
				<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
				<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ o.user_id=#apply_userDouble# ]]></isNotEmpty>
			</isNotEmpty>
		</isNotEmpty>
		
		<isEmpty  property="apply_depts">
			<isNotEmpty prepend="AND" property="apply_perdepts">
				<![CDATA[ o.login_dept In ]]>
				<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
				<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ o.user_id=#apply_userDouble# ]]></isNotEmpty>
			</isNotEmpty>
		</isEmpty>
			
			
			
		</dynamic>
	</select>
	<select id="qkjStores_Order_update_item_list" parameterClass="java.util.Map" resultClass="StoresOrderItem">
		select i.*,p.name AS brand_name from qkj_t_order_item i LEFT JOIN qkj_t_protype p ON (i.brand=p.id) where order_id=#id#
	</select>
	<!-- Product End -->
	<delete id="qkjStores_OrderItemDelete" parameterClass="java.util.Map">
		DELETE FROM qkj_t_order_item
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="id"><![CDATA[ id=#id# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="orderid"><![CDATA[ order_id=#orderid# ]]></isNotEmpty>
		</dynamic>
	</delete>
	<update id="qkjStores_orderPrice" parameterClass="java.util.Map">
		update qkj_t_order set total_price=#price# where id=#id#
	</update>
	<update id="qkjStores_update_OrderItem" parameterClass="java.util.Map">
		update qkj_t_order_item set order_num=#num#,order_total_price=#price# WHERE id = #id#
	</update>
	<delete id="qkjStores_delete_OrderAndItem" parameterClass="java.util.Map">
		DELETE FROM qkj_t_order
		WHERE id = #orderid#
	</delete>
		<select id="qkjStores_getOrderWeek" parameterClass="java.util.Map" resultClass="StoresOrder">
		select * from qkj_t_order WHERE datediff(day,[add_time],getdate())=0 and user_id=#userid# and is_liqueur_ticket=#is_liqueur_ticket# order by add_time DESC
	</select>
		<delete id="qkjStores_deleteStoresOrderPrice" parameterClass="java.util.Map">
		DELETE FROM qkj_t_order_custom
		WHERE product_id = #productid# and login_dept=#logindept#
	</delete>
		<select id="qkjStores_getStoresOrderItemByorderid" resultClass="StoresOrderItem" parameterClass="java.util.Map">
		<![CDATA[ 
			SELECT * from qkj_t_order_item where order_id=#order_id#
		]]>
	</select>
		<update id="qkjStores_order_is_library" parameterClass="java.util.Map">
		<![CDATA[ update qkj_t_order set is_library=1 	]]>
			<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="id"><![CDATA[ id=#id# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="is_library"><![CDATA[ is_library=#is_library# ]]></isNotEmpty>
					</dynamic>
	</update>

	<select id="qkjStores_get_order" resultClass="StoresOrder" parameterClass="java.util.Map">
		<![CDATA[ 
			SELECT * from qkj_t_order 
				]]>
				<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="id"><![CDATA[ id=#id# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="is_library"><![CDATA[ is_library=#is_library# ]]></isNotEmpty>
		</dynamic>
	</select>

<insert id="qkjStores_order_add_Ticket" parameterClass="StoresTicket">  
    <![CDATA[
        insert into qkj_t_ticket(product_id,ticket_name,start_time,end_time,product_code,num,user_id,user_name,login_name,login_dept) values 
        (#product_id#,#ticket_name#,#start_time#,#end_time#,#product_code#,#num#,#user_id#,#user_name#,#login_dept#,#login_name#)  
    ]]>
	</insert>
	
			<select id="qkjStores_Order_Ticket_list" resultClass="StoresTicket" parameterClass="java.util.Map">
		<![CDATA[ 
			SELECT * from qkj_t_ticket where convert(varchar(100), getdate(), 23)>=start_time and convert(varchar(100), getdate(), 23)<=end_time
		]]>
	</select>
	
	
	
	
	<select id="qkjStores_Ticket_list" parameterClass="java.util.Map" resultClass="StoresTicket">
		select * from qkj_t_ticket t
		<dynamic prepend="WHERE">
		<isNotEmpty prepend="AND" property="id"><![CDATA[ id=#id# ]]></isNotEmpty>
		<isNotEmpty prepend="AND" property="ticket_name"><![CDATA[ ticket_name=#ticket_name# ]]></isNotEmpty>
		<isNotEmpty prepend="AND" property="start_time"><![CDATA[ start_time=#start_time# ]]></isNotEmpty>
		<isNotEmpty prepend="AND" property="end_time"><![CDATA[ end_time=#end_time# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="apply_depts" open="(" close=")">
			<![CDATA[ t.login_dept In ]]>
			<iterate property="apply_depts" open="(" close=")" conjunction=" , "> #apply_depts[]#</iterate>
			<isNotEmpty prepend="OR" property="apply_perdepts">
				<![CDATA[ t.login_dept In ]]>
				<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
				<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ t.user_id=#apply_userDouble# ]]></isNotEmpty>
			</isNotEmpty>
		</isNotEmpty>
		
		<isEmpty  property="apply_depts">
			<isNotEmpty prepend="AND" property="apply_perdepts">
				<![CDATA[ t.login_dept In ]]>
				<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
				<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ t.user_id=#apply_userDouble# ]]></isNotEmpty>
			</isNotEmpty>
	
		</isEmpty>
			
		</dynamic>
	</select>
	
	
	
	<select id="qkjStores_Ticket_listCount" parameterClass="java.util.Map" resultClass="int">
		select count(*) from qkj_t_ticket t
		<dynamic prepend="WHERE">
		
			<isNotEmpty prepend="AND" property="apply_depts" open="(" close=")">
			<![CDATA[ t.login_dept In ]]>
			<iterate property="apply_depts" open="(" close=")" conjunction=" , "> #apply_depts[]#</iterate>
			<isNotEmpty prepend="OR" property="apply_perdepts">
				<![CDATA[ t.login_dept In ]]>
				<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
				<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ t.user_id=#apply_userDouble# ]]></isNotEmpty>
			</isNotEmpty>
		</isNotEmpty>
		
		<isEmpty  property="apply_depts">
			<isNotEmpty prepend="AND" property="apply_perdepts">
				<![CDATA[ t.login_dept In ]]>
				<iterate property="apply_perdepts" open="(" close=")" conjunction=" , "> #apply_perdepts[]#</iterate>
				<isNotEmpty prepend="AND" property="apply_userDouble"><![CDATA[ t.user_id=#apply_userDouble# ]]></isNotEmpty>
			</isNotEmpty>
		
		</isEmpty>
			
		</dynamic>
	</select>
		<delete id="qkjStores_ticket_del" parameterClass="java.util.Map">
		DELETE FROM qkj_t_ticket
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="id"><![CDATA[ id=#id# ]]></isNotEmpty>
		</dynamic>
	</delete>
	
</sqlMap>